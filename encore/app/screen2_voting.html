<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Londrina+Solid:wght@100;300;400;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="application/javascript">
        window.addEventListener("load", () => {
            window.dispatchEvent(new Event("eip6963:requestProvider"));
        });

        let providers = [];
        window.addEventListener("eip6963:announceProvider", (event) => {
            console.log("received provider", event.detail.info);
            providers.push(event.detail);
            showProviderIcon(event.detail);
        });

        let provider;
        window.addEventListener("load", () => {
            if (provider) {
                console.log("provider already set");
                return;
            }
            if (providers.length !== 0) {
                changeProvider(providers[0].provider, `${providers[0].info.name} ${providers[0].info.rdns} ${providers[0].info.uuid}`);
                return;
            }
            if (window.ethereum) {
                changeProvider(window.ethereum, `window.ethereum: ${window.ethereum.constructor.name}`);
                return;
            }
            console.log("no provider available");
        });

        function changeProvider(newProvider, name) {
            if (provider === newProvider) {
                console.log("provider unchanged");
                return;
            }
            if (provider) {
                console.log("disconnecting provider")
                provider.off('accountsChanged', accountsChanged);
                provider.off('chainChanged', chainChanged);
            }
            provider = newProvider;
            console.log(`provider changed to ${name}`);

            provider.on('accountsChanged', accountsChanged);
            provider.on('chainChanged', chainChanged);

            getAccounts().then(accountsChanged).catch((msg) => {
                console.log("no accounts available");
                console.log(msg);
            })
            getChain().then(chainChanged).catch((msg) => {
                console.log("no chain available");
                console.log(msg);
            })
        }

        const accountBox = document.querySelector('#account-box');
        let currentAccount;

        function accountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log("no accounts available");
                return;
            }
            if (accounts[0] === currentAccount) {
                console.log("account unchanged", currentAccount);
                return;
            }
            currentAccount = accounts[0];
            console.log("accountChanged", currentAccount);
            accountBox.textContent = currentAccount;

            window.dispatchEvent(new Event("web3AccountChanged"));
        }

        async function getAccounts() {
            return await provider.request({method: 'eth_requestAccounts'});
        }

        const chainBox = document.querySelector('#chain-box');
        let currentChain;

        function chainChanged(chain) {
            if (chain === currentChain) {
                console.log("chain unchanged", currentChain);
                return;
            }
            currentChain = chain;
            console.log("chainChanged", currentChain);
            chainBox.textContent = currentChain;

            window.dispatchEvent(new Event("web3ChainChanged"));
        }

        async function getChain() {
            return await provider.request({method: 'eth_chainId'});
        }

        const providerIconsDiv = document.querySelector('#provider-icons');

        function showProviderIcon(provider) {
            let img = document.createElement('img');
            img.height = 32;
            img.src = provider.info.icon;
            img.title = provider.info.name;
            img.alt = provider.info.name;
            img.classList.add('provider-icon');
            img.addEventListener('click', function () {
                changeProvider(provider.provider, `${provider.info.name} ${provider.info.rdns} ${provider.info.uuid}`);
            });
            providerIconsDiv.appendChild(img);
        }


        const options = {
            headers: {
                'Content-Type': 'application/json'
            },
        };

        const titleBox = document.querySelector('#title-box');
        const requestBox = document.querySelector('#request-box');
        let requestData;

        function providerChanged() {
            if (!currentAccount || !currentChain) {
                console.log("no account or chain available");

                requestData = null;
                requestBox.innerText = "";

                return;
            }
            fetch(`/permit/sign-request/${currentAccount}/${currentChain}`, options)
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    titleBox.innerText = data.title;
                    document.title = data.title;

                    return data.request;
                })
                .then(data => {
                    requestData = data;
                    requestBox.innerText = JSON.stringify(data, null, 2);
                    resultBox.innerText = "";
                })
                .catch(error => console.log("ERROR", error));
        }

        window.addEventListener("web3ProviderChanged", providerChanged);
        window.addEventListener("web3AccountChanged", providerChanged);
        window.addEventListener("web3ChainChanged", providerChanged);

        const sendButton = document.querySelector('#send-button');
        const resultBox = document.querySelector('#result-box');
        sendButton.addEventListener("click", async () => {
            const result = await provider.request(requestData);
            console.log(result);

            fetch(`/permit/encode/${requestData.params[1].message.holder}/${requestData.params[1].message.spender}/${requestData.params[1].message.nonce}/${requestData.params[1].message.expiry}/${result}`, options)
                .then(response => response.json())
                .then(data => data.response)
                .then(data => {
                    console.log(data);
                    resultBox.innerText = data;
                    requestBox.innerText = "";
                })
                .catch(error => console.log("ERROR", error));
        })
    </script>
    <title>ETHWarsaw Community Voting</title>
    <div id="provider-icons"></div>
    <h3>From Account: <span id="account-box"></span></h3>
    <h4>On Network: <span id="chain-box"></span></h4>
    <style>
        body {
            font-family: "Londrina Solid", serif;
            margin: 0;
            padding: 0;
            background-color: #FFD64D;
            color: #000;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1em 5%;
            margin-top: 2em;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 30px;
            text-align: left;
            padding-left: 260px;
        }

        .logo img {
            height: 50px;
            order: 0;
        }

        .logo-title {
            font-size: 3em;
            font-weight: bold;
            margin-left: 10px;
            margin-right: 0;
            order: 1;
            text-decoration: none;
            color: inherit;
            padding-right: 30px;
        }

        .logo-title a {
            text-decoration: none;
            color: inherit;
        }

        .logo-title a:hover {
            text-decoration: none;
        }
        .tagline {
            margin-top: 8px;
            font-size: 1.1em;
            line-height: 1.2em;
            margin-left: 10px;
            padding-right: 30px;
        }

        .button-group {
            display: flex;
            gap: 1em;
            margin-right: 16em;
        }

        .button {
            background-color: white;
            color: black;
            border: 2px solid black;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            text-transform: uppercase;
        }

        .button:hover {
            background-color: black;
            color: white;
        }

        .welcome {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            margin: 2em 0 1em;
        }

        .welcome img {
            height: 100px;
            margin-left: 20px;
            padding-bottom: 5px;
        }

        .green-box {
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 20px;
            margin: 0 auto 2em;
            max-width: 600px;
            border-radius: 8px;
            font-size: 1.6em;
        }

        .voting-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .option {
            background-color: #FF3377;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .option button {
            background-color: white;
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }

        .option button:hover {
            background-color: black;
            color: white;
        }

        .footer {
            margin-top: 3em;
            font-size: 0.9em;
            color: black;
            text-align: center;
        }

        .footer a {
            color: black;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://staging-bkk-ucfi.encr.app/web/assets/pink-purple-multi320px.png" alt="Glasses">
            <div>
                <div class="logo-title"><a href="https://staging-bkk-ucfi.encr.app/app/">AnonyMight</a></div>
                <div class="tagline">Giving communities the power to decide,<br> driven by verified event participation</div>
            </div>
        </div>
        <div class="button-group">
            <button class="button" onclick="window.location.href='http://localhost:2137/'">Verify with vLayer</button>
            <button class="button">Connect Wallet</button>
        </div>
    </div>

    <div class="welcome">
        Welcome to ETHWarsaw Community Voting
        <img src="https://staging-bkk-ucfi.encr.app/web/assets/nouns_assets_squid0.png" alt="Squid Image">
    </div>

    <div class="green-box">
        What topic should we cover on the next meetup?<br>
        Voting ends on December 15th 2024 at 23:59 CET
    </div>

    <div class="voting-options">
        <div class="option">
            <span>Interplanetary Consensus: the Filecoin Stack Explained (in Plain Language)</span>
            <button>Vote</button>
        </div>
        <div class="option">
            <span>StarkNet: The road to decentralization</span>
            <button>Vote</button>
        </div>
        <div class="option">
            <span>Charting a course toward sustainable public goods funding</span>
            <button>Vote</button>
        </div>
    </div>

    <div class="footer">
        <a href="#">Terms & Conditions</a>
        <span> | </span>
        <a href="https://twitter.com/ETHWarsaw">Reach out to us on X</a>
    </div>
</body>
</html>
